<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TonExpress Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://unpkg.com/tonweb@0.0.66/dist/tonweb.js"></script>
    <style>
        body {
            background-color: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            text-align: center;
        }
        h1 { margin-bottom: 10px; font-size: 32px; }
        p { color: #aaa; margin-bottom: 30px; }
        .price { font-size: 24px; color: #f39c12; margin-bottom: 30px; font-weight: bold; }
        
        .btn-buy {
            background: linear-gradient(90deg, #0088cc, #005f8f);
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 20px;
            border-radius: 16px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 136, 204, 0.4);
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .btn-buy:active { transform: scale(0.96); box-shadow: 0 2px 5px rgba(0, 136, 204, 0.4); }
        #ton-connect { margin-bottom: 20px; }
    </style>
</head>
<body>

    <h1>üöÇ TonExpress</h1>
    <p>–ü–æ–µ–∑–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è! –£—Å–ø–µ–π –∑–∞–Ω—è—Ç—å –º–µ—Å—Ç–æ.</p>
    
    <div class="price">üéü –¶–µ–Ω–∞ –±–∏–ª–µ—Ç–∞: 1 TON</div>

    <div id="ton-connect"></div>

    <button id="buyBtn" class="btn-buy" style="display:none;" onclick="buyTicket()">
        –ö–£–ü–ò–¢–¨ –ë–ò–õ–ï–¢
    </button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); 

        // 1. –ê–¥—Ä–µ—Å —Ç–≤–æ–µ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
        const CONTRACT_ADDRESS = "EQDq4lTJngXgrehoYa9YK9cJBEycGb0kdBwrlMuUuGvXnItC";
        
        // 2. Opcode –∫–æ–º–∞–Ω–¥—ã Buy (–∏–∑ —Ç–≤–æ–µ–≥–æ —Ñ–∞–π–ª–∞)
        const OPCODE_BUY = 0x64a04fc7; 

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ TonConnect
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'tonconnect-manifest.json',
            buttonRootId: 'ton-connect'
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–∫—É–ø–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω
        tonConnectUI.onStatusChange(wallet => {
            document.getElementById('buyBtn').style.display = wallet ? 'block' : 'none';
        });

        async function buyTicket() {
            try {
                // –°–æ–∑–¥–∞–µ–º payload (–∫–æ–º–∞–Ω–¥—É –¥–ª—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞)
                const cell = new TonWeb.boc.Cell();
                cell.bits.writeUint(OPCODE_BUY, 32); // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º Opcode
                const payload = TonWeb.utils.bytesToBase64(await cell.toBoc());

                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 120, // 2 –º–∏–Ω—É—Ç—ã –Ω–∞ –æ–ø–ª–∞—Ç—É
                    messages: [
                        {
                            address: CONTRACT_ADDRESS,
                            amount: "1000000000", // 1 TON (–≤ –Ω–∞–Ω–æ—Ç–æ–Ω–∞—Ö)
                            payload: payload 
                        }
                    ]
                };

                await tonConnectUI.sendTransaction(transaction);
                alert("‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å –∫–æ—à–µ–ª–µ–∫.");
            } catch (e) {
                console.error(e);
                alert("‚ùå –û—à–∏–±–∫–∞: " + e);
            }
        }
    </script>
</body>

</html>
